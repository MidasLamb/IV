<!DOCTYPE html>
<html>
    <head>
        <title>IV: Project</title>

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="DC.title" content="Dataset: gis/zone30 map | The Datatank"/>
        <meta charset="utf-8">
        <base target="_parent" />

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script type="text/javascript" src='http://datasets.antwerpen.be/v4/public/js/leaflet.min.js'></script>
        <link rel="stylesheet" href="http://datasets.antwerpen.be/v4/public/css/leaflet.css?v=1.0" />
        <link type="text/css" rel="stylesheet" href="noUiSlider.11.1.0/nouislider.min.css"/>
        <style>
            * {
                box-sizing: border-box;
            }

            body { margin:0; padding:0; font-family: sans-serif; overflow: hidden}
            #map { position:absolute; top:0; bottom:0; width:100%; }
            .fiets-route {
                stroke-opacity: 1.0;
                cursor: pointer;
            }

            .car-route {
                stroke: black !important;
            }

            .car-route.active {
                stroke-opacity: 1.0;
                stroke: black !important;
            }

            .hideimportant {
                display: none !important;
            }

            .hide {
                display: none;
            }

            #controls {
                display: grid;
                grid-template-areas: 
                    "left head head right rightbar"
                    "left center center right rightbar"
                    "footer footer footer footer rightbar";
                grid-template-columns: 1fr 5fr 3fr 2fr 75px;
                grid-template-rows: 1fr 1fr 170px;
                position: absolute;
                top:0px;
                bottom: 0px;
                left: 0px;
                right: 0px;
                z-index: 200;
                pointer-events:none;
            }

            #controls.nographs {
                grid-template-areas: 
                    "left head head right rightbar"
                    "left center center right rightbar"
                    "footer footer footer right rightbar";
            }

            .control-panel.invisible {
                max-height: 0px;
                padding-top: 0px;
                padding-bottom: 0px;
                /*display: none;*/
                transition: max-height 0.5s, padding 0.2s 0.3s;
            }

            graphs.invisible {
                display: none;
            }

            #controls > div {
                pointer-events: all;
            }

            #rightbar {
                grid-area: rightbar;
                background: white;
                z-index: 100;
                box-shadow: 1px 1px 5px black;
            }

            #rightbar > .bar-item {
                font-size: 10pt;
                text-align: center;
                border: 2px solid black;
                height: 75px;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                padding: 3px 0;
            }

            #rightbar > .bar-item > svg {
                max-width: 70px;
                max-height: 70px;
                width: 100%;
                height: 100%;
                stroke: black;

            }

            #rightbar > .bar-item.inactive {
                border-color: lightgrey;
                color: lightgrey;
            }

            #rightbar > .bar-item.inactive > svg {
                fill: lightgrey;
                stroke: lightgrey;
            }

            #control-panels {
                grid-area: right;
                overflow-y: auto;
                padding-left: 10px;
            }

            .control-panel {
                background: white;
                border-radius: 5;
                box-shadow: 1px 1px 5px black;
                padding: 10px;
                transition: max-height 0.5s, padding 0.2s;
                
                overflow-y: hidden;
                max-height: 500px;
            }

            .imf-preview {
                pointer-events: none;
            }

            #time-controls {
            }

            #nouislider-wrapper {
                min-height: 50px;
                margin-top: 40px;
            }

            .control-panel.graphs {
                transition: transform 0.5s;
            }

            .control-panel.graphs.invisible{
                transform: translate(0, 34vh);
                transition: transform 0.5s;
                display: block;
                max-height: 100vh;
            }

            .graphs {
                grid-area: footer;
                background: white;

                display: grid;

                grid-template-rows: 20px 1fr 1fr 1fr 20px;
                grid-template-columns: 85% 15%;

                grid-template-areas: "graph legend"
                                        "graph switcherone"
                                        "graph switchertwo"
                                        "graph switcherthree"
                                        "graph padding";
                height: 100%;
                z-index: 10;
            }

            .graphs-outlet {
                grid-area: graph;

                display: grid;
                grid-template-columns: 33.333% 33.333% 33.333%;
                grid-template-rows: 100%;
            }

            .graphs-outlet:not(.show) {
                display: none;
            }

            #outlet-one.show { 
                display: block;
            }

            .legend {
                grid-area: legend;
                font-size: 0.8em;
                text-align: center;
                display: flex;
                justify-content: center;
            }

            .switcher {
                grid-column: 2;
                border: 1px solid black;
                padding: 0.5em;
                margin-left: 0.5em;
                color: #666;
                cursor: pointer;
                text-align: center;
                font-weight: 500;
            }

            .switcher.active {
                color: black;
                font-weight: 700;
            }

            .switcher:not(.active) {
                background-color: #eee;
            }

            .switcher:hover {
                font-weight: 700;
                color: #111;
            }

            .switcher-one { grid-area: switcherone}
            .switcher-two { grid-area: switchertwo}
            .switcher-three { grid-area: switcherthree}

            .graphs-outlet > div {
                grid-row: 1;
            }
            .subplot-1 { grid-column: 1 }
            .subplot-2 { grid-column: 2 }
            .subplot-3 { grid-column: 3 }

            #loader {
                background: white;
                z-index: 1000000;
                position:sticky;
                top: 0;
                left: 0;
                width : 100vw;
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                transition: opacity 0.5s;
            }

            #spinner {
                border: 16px solid #f3f3f3; /* Light grey */
                border-top: 16px solid #3498db; /* Blue */
                border-radius: 50%;
                width: 120px;
                height: 120px;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

        </style>
    </head>
    <body>
        <div id="loader">
            <div style="text-align: center">
                <h1>City of Antwerp</h1>
                <h2>Cycling Data</h2>
            </div>
            <div id="spinner"></div>
            <div>
                <h3>Loading...</h3>
            </div>
        </div>
        <div id='map'></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.js" integrity="sha256-j2LsvgOlQFIb2Mphb+tX7d5pNmFdpsJU+s5GNo3z63g=" crossorigin="anonymous"></script>
    <script src="/noUiSlider.11.1.0/nouislider.min.js"></script>
    <script src="/js/timeSlider.js"></script>
    <script src="/js/utility.js"></script>
    <script src="/js/var.js"></script>
    <script src="/js/heatmap/leafheat.js"></script>
    <script src="/js/heatmap/HeatLayer.js"></script>
    <script src="/js/story/story.js"></script>
    <script src="/js/filters.js"></script>
    <script src="/js/mapsetup.js"></script>
    <script src="/js/datareading.js"></script>
    <script src="/js/interactiveMapFilter.js"></script>
    <script src="/js/interactiveTimeFilter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script src="/js/individualRouteController.js"></script>
    <script src='/js/lodash.js'></script>
    <script>

        function hideLoader(){
            document.getElementById("loader").style.opacity = "0";
            setTimeout(() => {
                document.getElementById("loader").style.display = "none";
            }, 500);
        }

        function afterData() {
            // initialize map filter
            baseFilter = new Filter();
            imf = new InteractiveMapFilter(baseFilter);
            irc = new IndividualRouteController(baseFilter);

            // initialize time filter
            const addTimeFilter = () => {
                window.itf = new InteractiveTimeFilter(baseFilter);
                itf.setFilter(Filter.filterStartsInPeriod);
            }

            if (document.readyState != 'complete') {
                window.addEventListener('load', addTimeFilter);
            } else {
                addTimeFilter();
            }

            var outlets = document.querySelectorAll('.graphs-outlet');
            var elements = outlets[0].querySelectorAll('canvas');
            for (var i =0; i < elements.length; i++){
                var variable = elements[i].id.split("_")[0];
                var curout = elements[i].getContext('2d');3
                initializeLineChart(curout,variable);
            }
            var elements = outlets[1].querySelectorAll('canvas');
            for (var j =0; j < elements.length; j++){
                var variable = elements[j].id.split("_")[0];
                var curout = elements[j].getContext('2d');
                initializeBarChart(curout,variable);
            }
            var elements = outlets[2].querySelectorAll('canvas');
            for (var k =0; k < outlets.length; k++){
                var variable1 = elements[k].id.split("_")[0];
                var variable2 = elements[k].id.split("_")[1];
                var curout = elements[k].getContext('2d');
                initializeScatterChart(curout,variable1,variable2);
            }

            setTimeout(() => {
                hideLoader();
                setTimeout(() => { 
                    hideAll();
                }, 500);
            }, 500);
        }

        function hideAll(){
            var els = document.getElementsByClassName("bar-item");
            var i = 0;
            var f = () => {
                if (i < els.length){
                    show(els[i]);
                    i++
                    setTimeout(f, 250);
                }
            }
            f();
        }
    </script>

        <script>
            function show(element){
                var target = document.getElementById(element.dataset.target);
                target.classList.toggle("invisible");
                if (target.classList.contains("invisible")){
                    element.classList.add("inactive");
                } else {
                    element.classList.remove("inactive");
                }

                if (element.dataset.secondarytarget){
                    document.getElementById("controls").classList.toggle("nographs");
                }

                // var others = document.getElementsByClassName("control-panel");
                // for (var i = 0; i < others.length; i++){
                //     if (others[i] != target){
                //         others[i].classList.add("invisible");
                //     }
                // }
            }

            function toggleHeatmap(e){
                if(!e.checked){
                    hideHeatmap();
                } else {
                    showHeatmap();
                    hideIRC();
                    hidePointMap();
                }
            }

            function hideHeatmap(){
                heatMap.setOptions({show: false});
                document.getElementById("heatmapcheckbox").checked = false;
                document.getElementById("route-controls").style.display = "none";
            }

            function showHeatmap() {
                heatMap.setOptions({show: true});
                document.getElementById("route-controls").style.display = "";
                document.getElementById("point-controls").style.display = "none";
            }

            function showPointMap(){
                pointHeatMap.addTo(map);
                document.getElementById("point-controls").style.display = "";
            }

            function hidePointMap(){
                pointHeatMap.removeFrom(map);
                document.getElementById("point-controls").style.display = "none";
                document.getElementById("pointmapend").checked = false;
                document.getElementById("pointmapstart").checked = false;
            }

            function togglePointHeatmap(e, num){
                if (e.checked && num == 0){

                    showStartPoints = true;

                    baseFilter.call(Filter.updateRoutesAndGraphs());

                    showPointMap();                    
                    hideHeatmap();
                    document.getElementById("pointmapend").checked = false;
                    hideIRC();
                } else if (e.checked && num == 1){
                    showStartPoints = false;
                    baseFilter.call(Filter.updateRoutesAndGraphs());

                    showPointMap();

                    hideHeatmap();
                    document.getElementById("pointmapstart").checked = false;
                    hideIRC();
                } else {
                    pointHeatMap.removeFrom(map);
                }
            }
            function optionsChange(slider, option){
                let newoption = {};
                newoption[option] = slider.value;
                heatMap.setOptions(newoption);
            }

            function clearRadioButtons() {
                imf.removePreviewRectangle();
                var radiobuttons = document.getElementsByClassName("imf-button");
                for (var i = 0; i < radiobuttons.length; i++){
                    radiobuttons[i].checked = false;
                }
            }

            function mapFilter(element, filter){
                if (element.checked){
                    imf.removePreviewRectangle();
                    imf.setFilter(filter);
                    imf.enable();
                } else {
                    imf.removeMapFilter()
                }

            }

            function addFilter(element){
                if(element.checked) {
                    baseFilter.addFilter(Filter.filterProfession("student"), "students").applyFilters().call(Filter.updateRoutesAndGraphs());
                } else {
                    baseFilter.removeFilterByName("students").applyFilters().call(Filter.updateRoutesAndGraphs());
                }
            }

            function addProfessionFilter(element, name, filters){
                if(element.checked) {
                    baseFilter.addFilter(Filter.filterProfession(filters), name).applyFilters().call(Filter.updateRoutesAndGraphs());
                } else {
                    baseFilter.removeFilterByName(name).applyFilters().call(Filter.updateRoutesAndGraphs());
                }
            }

            function toggleIRC(element){
                if (element.checked){
                    showIRC();
                    hideHeatmap();
                    hidePointMap();
                } else {
                    hideIRC();
                }
            }

            function hideIRC(){
                document.getElementById("indi-controls").style.display = "none";
                document.getElementById("irccheckbox").checked = false;
                irc.disable();
            }

            function showIRC(){
                document.getElementById("indi-controls").style.display = "";
                document.getElementById("irccheckbox").checked = true;
                irc.enable();

            }
            
            function createGradient() {
                // create a 256x1 gradient that we'll use to turn a grayscale heatmap into a colored one
                var canvas = document.getElementById("heatscale"),
                    ctx = canvas.getContext('2d'),
                    gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);

                var grad =  {
                    0.4: 'blue',
                    0.6: 'cyan',
                    0.7: 'lime',
                    0.8: 'yellow',
                    1.0: 'red'
                };

                canvas.height = 5;

                for (var i in grad) {
                    gradient.addColorStop(+i, grad[i]);
                }

                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, 5);
            }

            function filterFasterThanCar(num){
                if (num == 0){
                    baseFilter.removeFilterByName("carcompare").applyFilters().call(Filter.updateRoutesAndGraphs());
                } else if (num == 1) {
                    baseFilter.addFilter(Filter.filterCarSlower(), "carcompare").applyFilters().call(Filter.updateRoutesAndGraphs());
                } else if (num == 2) {
                    baseFilter.addFilter(Filter.filterCarFaster(), "carcompare").applyFilters().call(Filter.updateRoutesAndGraphs());
                }
            }
            
            function changePointRadius(e){
                pointHeatMap.setOptions({"radius": +e.value});
            }

            var currentdays = [0,1,2,3,4,5,6];
            function toggleDay(day){
                if (currentdays.includes(day)){
                    var index = currentdays.indexOf(day);
                    if (index !== -1) currentdays.splice(index, 1);
                } else {
                    currentdays.push(day);
                }
                baseFilter.removeFilterByName("days").addFilter(Filter.filterDays(currentdays), "days").applyFilters().call(Filter.updateRoutesAndGraphs());
            }

        </script>
        <div id="controls">
            <div id="control-panels">
                <div class="control-panel" id="time-controls">
                    <h2>Time Controls</h2>
                    <h3>Time of day</h3>
                    <div id="nouislider-wrapper">
                        <div id="time-slider" style="position: relative; margin-left: 10%; width: 80%;"></div>
                    </div>
                    <h3>Day</h3>
                    <div>
                        <label><input type="checkbox" checked onclick="toggleDay(1)">Monday</label><br>
                        <label><input type="checkbox" checked onclick="toggleDay(2)">Tuesday</label><br>
                        <label><input type="checkbox" checked onclick="toggleDay(3)">Wednesday</label><br>
                        <label><input type="checkbox" checked onclick="toggleDay(4)">Thursday</label><br>
                        <label><input type="checkbox" checked onclick="toggleDay(5)">Friday</label><br>
                        <label><input type="checkbox" checked onclick="toggleDay(6)">Saturday</label><br>
                        <label><input type="checkbox" checked onclick="toggleDay(0)">Sunday</label><br>
                    </div>
                </div>
                <div class="control-panel" id="heatmap-controls">
                    <h2>Heatmap Controls</h2>
                    <div>
                        <label><input id="heatmapcheckbox" type="checkbox" checked onchange="toggleHeatmap(this)"> Route Heatmap </label> <br>
                        <label><input id="pointmapstart" type="checkbox" onchange="togglePointHeatmap(this, 0)"> Point Heatmap (Route start)</label> <br>
                        <label><input id="pointmapend" type="checkbox" onchange="togglePointHeatmap(this, 1)"> Point Heatmap (Route end)</label> <br>
                        <label><input type="checkbox" id="irccheckbox" onclick="toggleIRC(this)"> Individual Routes</label>
                    </div>
                    <div id="route-controls">
                        <div>
                            <h3>Scale</h3>
                            1 <canvas id="heatscale" style="max-width:256px; width:80%";></canvas> <span id="heatmapmax">256</span>
                            <script>
                                createGradient();
                            </script>
                        </div>
                        <div>
                            <h3>Line Width</h3>
                            Narrow <input type="range" min="1" max="30" value="3" onchange="optionsChange(this, 'lineWidth')"> Wide
                        </div>
                        <div>
                            <button onclick="heatMap.resetDefaultOptions()">Reset default</button>
                        </div>
                    </div>
                    <div id="point-controls" style="display: none">
                        <div>
                            <h3>Point Radius</h3>
                            Narrow <input type="range" min="1" max="100" value="25" onchange="changePointRadius(this)"> Wide
                        </div>
                    </div>
                    <div id="indi-controls" style="display: none">
                        <h3>Legend</h3>
                        <span style="width:10px; height: 10px; background-color: orange; display: inline-block;"></span> Bike </br>
                        <span style="width:10px; height: 10px; background-color: #4286f4; display: inline-block;"></span> Bike faster than car </br>
                        <span style="width:10px; height: 10px; background-color: red; display: inline-block;"></span> Bike slower than car </br>
                        <span style="width:10px; height: 10px; background-color: black; display: inline-block;"></span> Car with same start and end points 
                    </div>
                </div>
                <div class="control-panel" id="interactive-map-controls">
                    <h2>Position Filter</h2>
                    <label><input type="radio" name="map" class="imf-button" onclick="mapFilter(this, Filter.filterStartWithin)"> Starts Within</label> <br>
                    <label><input type="radio" name="map" class="imf-button" onclick="mapFilter(this, Filter.filterStopsWithin)"> Stops Within</label> <br>
                    <label><input type="radio" name="map" class="imf-button" onclick="mapFilter(this, Filter.filterGoesThrough)"> Goes Through</label> <br>

                    <button onclick="imf.removeMapFilter();clearRadioButtons()">Clear</button>
                </div>
                <div class="control-panel" id="car-compares">
                    <h2>Compare with Cars</h2>
                    <div>
                        <label><input type="radio" checked name="speedcomp" onclick='filterFasterThanCar(0)'>All</label> <br>
                        <label><input type="radio" name="speedcomp" onclick='filterFasterThanCar(1)'>Bike faster Than Car</label> <br>
                        <label><input type="radio" name="speedcomp" onclick='filterFasterThanCar(2)'>Bike slower Than Car</label> <br>
                    </div>
                </div>
                <div class="control-panel" id="data-filter">
                    <h2>Profession Filters</h2>
                    <label><input type="checkbox" onclick='addProfessionFilter(this, "students", "student")'>Only students</label>
                </div>
            </div>

            <div id="rightbar">
                <div class="bar-item" data-target="time-controls" onclick="show(this)">
                    <svg version="1.1" id="Laag_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                        viewBox="296 207 273 245"  xml:space="preserve">
                        <style type="text/css">
                        </style>
                        <g>
                            <path d="M430.5,226c55.4,0,100.5,45.1,100.5,100.5S485.9,427,430.5,427S330,381.9,330,326.5S375.1,226,430.5,226 M430.5,216
                                c-61,0-110.5,49.5-110.5,110.5S369.5,437,430.5,437S541,387.5,541,326.5S491.5,216,430.5,216L430.5,216z"/>
                        </g>
                        <g>
                            <circle class="st0" cx="432.5" cy="328.5" r="5.5"/>
                            <path d="M432.5,328c0.3,0,0.5,0.2,0.5,0.5s-0.2,0.5-0.5,0.5s-0.5-0.2-0.5-0.5S432.2,328,432.5,328 M432.5,318
                                c-5.8,0-10.5,4.7-10.5,10.5s4.7,10.5,10.5,10.5s10.5-4.7,10.5-10.5S438.3,318,432.5,318L432.5,318z"/>
                        </g>
                        <rect x="428" y="244" width="8" height="84"/>
                        <rect x="445.2" y="320" transform="matrix(0.7071 -0.7071 0.7071 0.7071 -113.2686 420.8715)" width="12.4" height="54.4"/>
                    </svg>
                </div>
                <div class="bar-item" data-target="heatmap-controls" onclick="show(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Camada_1" x="0px" y="0px" width="308px" height="534px" viewBox="151.5 50.5 308 534" enable-background="new 151.5 50.5 308 534" xml:space="preserve">
                        <path d="M430.095,366.991c-32.803-42.283-33.434-90.521-16.298-133.116c-36.315,35.569-56.763,79.548-42.484,123.955  c1.812,5.648,2.974,11.181,3.824,16.83l0.325,6.812l-2.026,0.746l-8.623-19.706c-12.252-33.538-14.058-68.899-2.025-105.215  c23.96-71.133-7.344-140.785-64.426-196.795c26.304,67.724,23.856,144.726-29.388,212.884c-10.227,12.993-18.636,26.2-25.343,39.719  l-4.052,8.941l0.324-2.338c10.753-45.789-12.674-87.326-51.652-118.63c20.232,40.569,23.323,88.71-6.071,134.499  c-24.603,47.277-30.888,105.962-11.609,149.519c30.141,62.938,70.185,91.903,124.604,93.391c7.876,0.104,15.973-0.208,24.283-1.278  c44.407-4.792,99.891-26.506,117.779-77.944C454.911,455.162,463.326,410.003,430.095,366.991z"/>
                        </svg>
                </div>
                <div class="bar-item" data-target="interactive-map-controls" onclick="show(this)">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                        viewBox="720 216 284 412" style="enable-background:new 0 0 1366 768;" xml:space="preserve">
                        <style type="text/css">
                            .st1{fill:none;stroke-width:20;stroke-miterlimit:10;}
                        </style>
                        <g id="MapFilter">
                            <path class="st1" d="M864,610c0,0-117-184.4-117-249s52.4-117,117-117s117,52.4,117,117S864,610,864,610z"/>
                            <circle class="st1" cx="864" cy="362" r="47"/>
                        </g>
                    </svg>
                </div>
                <div class="bar-item" data-target="car-compares" onclick="show(this)">
                        <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.0" viewbox="-10 0 290 186.79424" id="svg2">
                            <metadata id="metadata12">
                              <rdf:RDF>
                                <cc:Work rdf:about="">
                                  <dc:format>image/svg+xml</dc:format>
                                  <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>
                                  <dc:title/>
                                </cc:Work>
                              </rdf:RDF>
                            </metadata>
                            <defs id="defs4"/>
                            <path d="M 62.32168,3.2317821 C 50.29537,4.2194521 42.74954,11.615292 38.60294,21.981782 l -19.312504,49.21874 15.562504,-1.03125 16.96874,-43.12499 c 1.55499,-3.62827 5.70551,-7.16916 10.5,-7.6875 44.76701,-5.89367 104.59647,-6.21939 155.71871,0 4.79448,0.51834 8.85126,4.05923 10.40625,7.6875 l 16.96874,43.12499 15.5625,1.03125 -19.3125,-49.21874 C 237.51875,11.615292 229.94613,4.4325121 218.04039,3.2317821 c -44.85164,-4.52341 -105.92629,-4.08921003 -155.71871,0 z m 77.81248,62.9999899 c -35.39855,0.16437 -70.71852,3.32294 -105.84372,7.59375 C 19.625726,75.877802 9.9982958,79.060892 4.7591958,87.606762 -5.4399642,104.24347 0.46216587,130.8255 25.29044,130.8255 l 101.34372,0 27,0 101.34372,0 c 24.82826,0 30.7304,-26.58203 20.53124,-43.218738 -5.2391,-8.54587 -14.86652,-10.60396 -29.53124,-12.65625 -35.1515,-3.84883 -70.43662,-8.88316 -105.84372,-8.71874 z M 31.47794,85.263012 c 10.15941,0 18.37499,8.2156 18.37499,18.374998 0,10.15937 -8.21558,18.46877 -18.37499,18.46874 -10.159384,0 -18.468744,-8.30937 -18.468754,-18.46874 0,-10.159388 8.30937,-18.375048 18.468754,-18.374998 z m 217.40619,0 c 10.15938,-5e-5 18.375,8.21561 18.375,18.374998 -3e-5,10.15937 -8.21562,18.46874 -18.375,18.46874 -10.15941,3e-5 -18.46874,-8.30937 -18.46874,-18.46874 0,-10.159398 8.30933,-18.374998 18.46874,-18.374998 z M 4.7591958,135.04425 c -2.58435,0 -4.68749993,2.0094 -4.68749993,4.59375 l 0,6.1875 c 0,2.58435 2.10314993,4.78124 4.68749993,4.78124 l 8.9999902,0 0,28.96875 c 0,3.96486 3.25384,7.21874 7.21875,7.21874 l 27.468744,0 c 3.96491,0 7.21875,-3.25382 7.21875,-7.21874 l 0,-28.96875 59.62499,0 49.78123,0 59.62499,0 0,28.96875 c 0,3.96492 3.16011,7.21874 7.125,7.21874 l 27.46874,0 c 3.96492,0 7.21875,-3.25388 7.21875,-7.21874 l 0,-28.96875 8.99999,0 c 2.58432,0 4.6875,-2.19689 4.6875,-4.78124 l 0,-6.1875 c 0,-2.58435 -2.10315,-4.59375 -4.6875,-4.59375 l -119.53121,0 -31.6875,0 -119.5312142,0 z" id="path2001" />
                          </svg>
                </div>
                <div class="bar-item" data-target="data-filter" onclick="show(this)">
                    <svg xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="svg4619" inkscape:version="0.91 r13725" sodipodi:docname="suitcase-15.svg" x="0px" y="0px" viewBox="0 0 15 15" xml:space="preserve">
                        <style>
                            #path17 {
                                fill: none;
                                stroke-width: 1px;
                            }
                        </style>
                        <path id="path17" inkscape:connector-curvature="0" sodipodi:nodetypes="csccsccssccssccccccc" d="M11,4V2c0-1-1-1-1-1H5.0497  c0,0-1.1039,0.0015-1.0497,1v2H2c0,0-1,0-1,1v7c0,1,1,1,1,1h11c0,0,1,0,1-1V5c0-1-1-1-1-1H11z M5.5,2.5h4V4h-4V2.5z"/>
                        </svg>
                </div>
                <div class="bar-item" data-target="graphs" data-secondarytarget="graphselector" onclick="show(this)">
                    <svg
                    x="0px"
                    y="0px"
                    viewBox="470 0 400 400"
                    xml:space="preserve"
                    >                            <defs
                      id="defs13"><marker
                        refY="0.0"
                        refX="0.0"
                        id="Arrow2Mstart"
                        style="overflow:visible"
                        inkscape:isstock="true"><path
                          id="path899"
                          style="fill-rule:evenodd;stroke-width:0.625;stroke-linejoin:round;stroke:#000000;stroke-opacity:1;fill:#000000;fill-opacity:1"
                          d="M 8.7185878,4.0337352 L -2.2072895,0.016013256 L 8.7185884,-4.0017078 C 6.9730900,-1.6296469 6.9831476,1.6157441 8.7185878,4.0337352 z "
                          transform="scale(0.6) translate(0,0)" /></marker></defs><sodipodi:namedview/>
                      <style type="text/css" id="style2">
                         .st4{fill:none;stroke-width:20;stroke-miterlimit:10;}
                     </style><g
                      id="Laag_3"
                      style="display:inline"><path
                        style="fill:none;stroke-width:20;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                        d="m 509.13913,64.639894 3.2835,271.262736 h 308.64929"
                        id="path1157"
                        inkscape:connector-curvature="0" /><path
                        style="fill:none;stroke-width:15;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                        d="m 517.58014,166.31749 103.44151,36.82272 128.83591,-64.51263 77.82665,30.15934"
                        id="path1159"
                        sodipodi:nodetypes="ccc" /><path
                        sodipodi:type="star"
                        style="fill:#000000;fill-opacity:1;;stroke-width:15;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                        id="path1163"
                        sodipodi:sides="3"
                        d="m 770.12471,258.44785 -28.55899,17.40106 -0.79027,-33.43333 z"
                        transform="matrix(0.93424712,0,0,0.83641023,119.56575,119.71033)" /><path
                        transform="matrix(0.00183835,-0.87706317,0.97511907,0.00204843,256.91837,725.62406)"
                        d="m 770.12471,258.44785 -28.55899,17.40106 -0.79027,-33.43333 z"
                        id="path1185"
                        style="fill:#000000;fill-opacity:1;stroke-width:15;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                        sodipodi:type="star" /></g></svg> 
                </div>
            </div>

            <div class="graphs control-panel" id="graphs">
                <div class="legend">
                    <table style="border-spacing: 0;">
                        <tr>
                            <td style="text-align: right; border-right: 1px black solid">
                                Bike faster than car <span style="width:10px; height: 10px; background-color: #4286f4; display: inline-block;"></span>
                            </td>
                            <td style="text-align: left;  border-left: 1px black solid">
                                <span style="width:10px; height: 10px; background-color: red; display: inline-block;"></span> Bike slower than car
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="switcher switcher-one active" data-target="outlet-one">Time plot</div>
                <div class="switcher switcher-two" data-target="outlet-two">Bar charts</div>
                <div class="switcher switcher-three" data-target="outlet-three">Scatter plots</div>
                <div class="graphs-outlet active show" id="outlet-one">
                    <div style="height:100%">
                        <div class="timeplot-container" style="position: relative; height: 100%; width: 100%; max-height: 100%; max-width: 100%;">
                            <canvas id="time_plot"></canvas>
                        </div>
                    </div>

                </div>
                <div class="graphs-outlet" id="outlet-two" style="position: relative; height: 100%; width: 100%; max-height: 100%; max-width: 100%;">
                        <div class="subplot-1" id="plot-bar-1" ><canvas id="age_bar"></canvas></div>
                        <div class="subplot-2" id="plot-bar-2" ><canvas id="speed_bar"></canvas></div>
                        <div class="subplot-3" id="plot-bar-3" ><canvas id="distance_bar"></canvas></div>
                </div>
                <div class="graphs-outlet" id="outlet-three">
                    <div class="subplot-1" id="plot-scatter-1"><canvas id="age_speed_plot"></canvas></div>
                    <div class="subplot-2" id="plot-scatter-2"><canvas id="speed_distance_plot"></canvas></div>
                    <div class="subplot-3" id="plot-scatter-3"><canvas id="age_distance_plot"></canvas></div>

                </div>
            </div>
 <script>


let switchers = document.querySelectorAll('.switcher');
        
function clickListener (e) {
    // e.target holds the clicked switcher
    var outlets = document.querySelectorAll('.graphs-outlet');
    for (let i = 0; i < outlets.length; i++) {
        var curOut = outlets[i];
        console.log(e.target.dataset.target);
        if (curOut.id == e.target.dataset.target) {
            curOut.classList.add('show');
            curOut.classList.add('active');
            console.log(curOut);
        } else {
            curOut.classList.remove('show');
            curOut.classList.remove('active');
        } 
    }
    // attach "active" class
    for (let i = 0; i < switchers.length; i++) {
        let curSwitcher = switchers[i]
        if (curSwitcher.dataset.target == e.target.dataset.target) {
           curSwitcher.classList.add('active');
            
        } else {
           curSwitcher.classList.remove('active');
        }
    }
}

// attach listeners
for (let i = 0; i < switchers.length; i++) {
    switchers[i].addEventListener('click', clickListener);
}


function makeAge(min,max,step,title){
    var curYear = (new Date()).getFullYear()
    return {
        "min": min,
        "max": max,
        "step": step,
        "func": (e) => ((isNaN(parseInt(e.extradata["Year"]))) ?  0 : Math.ceil((curYear - parseInt(e.extradata["Year"])-min)/step)) ,
        "data": (e) => ((isNaN(parseInt(e.extradata["Year"]))) ?  -1 : Math.ceil(curYear - parseInt(e.extradata["Year"]))),
        "missing": true,
        "title": title
    }
}
function makeTime(min,max,step,title){
    return {
        "min": min,
        "max": max,
        "step": step,
        "func": (e) => e.properties.STARTTIMEDATE.getHours()+1,
        "data": (e) => e.properties.STARTTIMEDATE.getHours(),
        "missing": false,
        "title": title
    }
}
function makeSpeed(min,max,step,title){
    return {
        "min": min,
        "max": max,
        "step": step,
        "func": (e) => Math.ceil((e.properties.REAL_SPEED-min)/step),
        "data": (e) => e.properties.REAL_SPEED,
        "missing": false,
        "title": title
    }
}
function makeDistance(min,max,step, title){
    return {
        "min": min,
        "max": max,
        "step": step,
        "func": (e) => Math.ceil((e.extradata["Distance"]-min)/step),
        "data": (e) => e.extradata["Distance"],
        "missing": false,
        "title": title
    }
}



var chartData = {
    "age": makeAge(15,85,10, "Age"),
    "time": makeTime(0,24,1, "Hour of ride"),
    "speed": makeSpeed(5,35,5, "Average speed (km/h)"),
    "distance": makeDistance(0,45,5, "Distance travelled (km)")
}
var plotcharts = {};

function initializeLineChart(ctx, variable) {
    var varData = chartData[variable];
    var datasts = getData(plotData(varData["func"]),variable)
    window.plotcharts[variable] = new Chart(ctx, {
        // The type of chart we want to create
        type: 'line',
        // Configuration options go here
        options: {
            scales: {
                xAxes: [{
                    stacked: true,
                    scaleLabel: {
                        display: true,
                        labelString: varData["title"]
                    }
                }],
                yAxes: [{
                    stacked: true,
                    scaleLabel: {
                        display: true,
                        labelString: "Amount"
                    }
                }]
            },
            legend: {
                display: false
            },
            layout: {
                padding: {
                 top: 0,
                 right: 0,
                 bottom: 5,
                 left: 0
                }
            },
            maintainAspectRatio: false,
            responsive: true
        },

        // The data for our dataset
        data: {
            labels: labels2(varData["min"],varData["max"],varData["step"],varData["missing"]),
            datasets: [{
                backgroundColor: 'rgb(255,0,0,0.5)',
                borderColor: 'rgb(255,0,0)',
                data: datasts[0]
            },
            {
                backgroundColor: 'rgb(66, 134, 244,0.5)',
                borderColor: 'rgb(66, 134, 244)',
                data: datasts[1]
            }]
        }
    });
}

function initializeBarChart(ctx, variable) {
    var varData = chartData[variable];
    var datasts = getData(plotData(varData["func"]),variable)
    window.plotcharts[variable] = new Chart(ctx, {
        // The type of chart we want to create
        type: 'bar',
        // Configuration options go here
        options: {
            scales: {
                xAxes: [{
                    stacked: true,
                    scaleLabel: {
                        display: true,
                        labelString: varData["title"]
                    }
                }],
                yAxes: [{
                    stacked: true,
                    scaleLabel: {
                        display: true,
                        labelString: "Amount"
                    }
                }]
            },
            legend: {
                display: false
            },
            layout: {
                padding: {
                 top: 0,
                 right: 0,
                 bottom: 5,
                 left: 0
                }
            },
            maintainAspectRatio: false,
            responsive: true
        },
    
        // The data for our dataset
        data: {
            labels: labels2(varData["min"],varData["max"],varData["step"],varData["missing"]),
            datasets: [{
                backgroundColor: 'rgb(255,0,0,0.8)',
                borderColor: 'rgb(255,0,0)',
                data: datasts[0]
            },
            {
                backgroundColor: 'rgb(66, 134, 244,0.8)',
                borderColor: 'rgb(66, 134, 244)',
                data: datasts[1]
            }]
        }
    });
}
var scattercharts = {};
function initializeScatterChart(ctx, variable1,variable2) {
    var varData1 = chartData[variable1];
    var varData2 = chartData[variable2];
    var datasts1 = plotData(varData1["data"],variable1)
    var datasts2 = plotData(varData2["data"],variable2)
    var scatterdataslower = createScatterData(datasts1[0],datasts2[0]);
    var scatterdatafaster = createScatterData(datasts1[1],datasts2[1]);
    window.scattercharts[variable1+"_"+variable2] = new Chart(ctx, {
        // The type of chart we want to create
        type: 'scatter',
        // Configuration options go here
        options: {
            showLines: false,
            scales: {
                xAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: varData1["title"]
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: varData2["title"]
                    }
                }]
            },
            legend: {
                display: false
            },
            elements: {
                point : {
                    radius: 2
                }
            },
            layout: {
                padding: {
                 top: 0,
                 right: 0,
                 bottom: 5,
                 left: 0
                }
            },
            maintainAspectRatio: false,
            responsive: true
        },

        // The data for our dataset
        data: {
            datasets: [{
                backgroundColor: 'rgb(66, 134, 244,0.8)',
                borderColor: 'rgb(66, 134, 244)',
                data: scatterdatafaster
            },
            {
                backgroundColor: 'rgb(255,0,0,0.8)',
                borderColor: 'rgb(255,0,0)',
                data: scatterdataslower
            },
            ]
        }
    });
}

function createScatterData(ar1, ar2){
    var data = [];
    for (i=0;i<ar1.length;i++){
        data.push({x: ar1[i], y: ar2[i]});
    }
    return data
}

function plotData(f){
    var datafaster = [];
    var dataslower = [];
    baseFilter.call(function(d){
        d.each((e)=>{
            if (e.properties.fasterThanCar){
                datafaster.push(f(e))
            }
            else{
                dataslower.push(f(e))
            }
        });
    });
    return [dataslower,datafaster];
};
function labels2(min,max,step,missing){
    var range = _.range(min,max+1,step);
    var lab = []
    if (missing){
        lab.push("unknown");
    }
    for (i = 0; i < range.length-1; i++) {
        lab.push(range[i].toString()+"-"+range[i+1].toString())
    }
    return lab
}

function labels(d){
    var max = Math.max.apply(Math, d);
    var min = Math.min.apply(Math, d);
    return Array.from(new Array(24), (x,i) => i);
};

function getData(dt,variable){
    var varData = chartData[variable];
    var lbls = _.range(1,((varData["max"]-varData["min"])/varData["step"])+1);
    if (varData["missing"]){
        lbls = _.range(0,((varData["max"]-varData["min"])/varData["step"])+1);
    }
    var alldata = [];

    for (var i = 0; i < dt.length; i++) {
        var counts = {};
        lbls.forEach((lb)=>
        {
            counts[lb] = 0;
        });
        dt[i].forEach(((e) => counts[e] = counts[e] + 1));
        data = [];
        for (var key in counts){
            data.push(counts[key]);
        }
        alldata.push(data);
    }
    return alldata;
};




</script>
    </body>
</html>