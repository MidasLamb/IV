<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link type="text/css" rel="stylesheet" href="noUiSlider.11.1.0/nouislider.min.css"/>
    <title>Document</title>
</head>
<body>
    <svg></svg>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.js" integrity="sha256-j2LsvgOlQFIb2Mphb+tX7d5pNmFdpsJU+s5GNo3z63g=" crossorigin="anonymous"></script>
    <script src="noUiSlider.11.1.0/nouislider.min.js"></script>
    <script>
        var width = 800;
        var height = 600;

        var projection = d3.geoMercator()
            .scale(60000)
            // Center the Map in Colombia
            .center([4.416164, 51.219785])
            .translate([width / 2, height / 2]);

        var path = d3.geoPath()
            .projection(projection);

        // Set svg width & height
        var svg = d3.select('svg')
            .attr('width', width)
            .attr('height', height);

        // Add background
        svg.append('rect')
            .attr('class', 'background')
            .attr('width', width)
            .attr('height', height)
            .on('mouseover', mouseover)
            .on('mouseout', mouseout)
            .on('click', clicked);

        var g = svg.append('g');

        var effectLayer = g.append('g')
            .classed('effect-layer', true);

        var mapLayer = g.append('g')
            .classed('map-layer', true);
        
        var streetLayer = g.append('g')
            .classed('street-layer', true);

        var pathLayer = g.append('g')
            .classed('path-layer', true);
        
        var schoolLayer = g.append('g')
            .classed('school-layer', true);

        var assisthouseLayer = g.append('g')
            .classed("assisthouse-layer", true);

        var zone30Layer = g.append('g')
            .classed("zone30-layer", true);

        var borgerhoutLayer = g.append('g')
            .classed("borgerhout-layer", true);


        function filterWork(d){
            //return d.properties.DIFF_TIME > 60;
            //return d.properties.REAL_SPEED > 15;
            return filterTimeRangeFunction(d);
            return d.properties.STARTTIMEDATE.getDay() > 0 && d.properties.STARTTIMEDATE.getDay() < 6
            && (d.properties.STARTTIMEDATE.getHours() >= 7 && d.properties.STARTTIMEDATE.getHours() <= 9 || d.properties.STARTTIMEDATE.getHours() >= 15 && d.properties.STARTTIMEDATE.getHours() <= 16);

        }

        d3.json("straatas.json", function(data){
            data = data.data;
            streetLayer.selectAll("polyline")
                .data(data)
                .enter()
                    .append("polyline")
                    .attr("points", (d) => {
                        coordinates = JSON.parse(d.geometry).coordinates;
                        coordinates = coordinates[0]
                        mapped = coordinates.map((p) => {
                            // console.log(p)
                            return projection(p).join(",");
                        }).join(" ");
                        return mapped;
                    }).attr("stroke", "white").attr("stroke-width", "2");
        });

        // d3.json("secundaireschool.json",
        //     function(data) {
        //         data = data.data;
        //         schoolLayer.selectAll("circle")
        //             .data(data)
        //             .enter()
        //                 .append("circle").attr("cx", (d) => {
        //                     return projection([d.point_lng, d.point_lat])[0];
        //                 }).attr("cy", (d) => {
        //                     return projection([d.point_lng, d.point_lat])[1]
        //                 }).attr("r", 2).attr("fill", "blue")
        // });

        // d3.json("basisschool.json",
        //     function(data) {
        //         data = data.data;
        //         schoolLayer.selectAll("circle")
        //             .data(data)
        //             .enter()
        //                 .append("circle").attr("cx", (d) => {
        //                     return projection([d.point_lng, d.point_lat])[0];
        //                 }).attr("cy", (d) => {
        //                     return projection([d.point_lng, d.point_lat])[1]
        //                 }).attr("r", 2).attr("fill", "green")
        // });


        // d3.json("assistentiewoningoverzicht.json",
        //     function(data) {
        //         data = data.data;
        //         assisthouseLayer.selectAll("circle")
        //             .data(data)
        //             .enter()
        //                 .append("circle").attr("cx", (d) => {
        //                     return projection([d.point_lng, d.point_lat])[0];
        //                 }).attr("cy", (d) => {
        //                     return projection([d.point_lng, d.point_lat])[1]
        //                 }).attr("r", 2).attr("fill", "yellow")
        // });

        d3.json("zone30.json", function(data) {
            data = data.data;
            zone30Layer.selectAll("polygon")
                .data(data)
                .enter()
                .append("polygon")
                .attr("points", (d) => {
                    coordinates = JSON.parse(d.geometry).coordinates;
                    if (coordinates.length > 1){
                        points = []
                        coordinates.forEach((e) => points.concat(e));
                    } else {
                        points = coordinates[0];
                    }
                    return points.map((p) => {
                        return projection(p).join(",");
                    }).join(" ");
                }).attr("fill", "blue").attr("opacity", "0.2")
        });
        }

        function filterTimeRangeFunction(d) {
            let timeHandles = handlesSlider.noUiSlider.get();
            let getMinutes = (date) => date.getHours() * 60 + date.getMinutes();
            let startMinutes = getMinutes(d.properties.STARTTIMEDATE);
            //let stopMinutes = getMinutes(d.properties.STOPTIMEDTE);
            return startMinutes > timeHandles[0] && startMinutes < timeHandles[1];
        }

        d3.json("fiets_routes_CC.geojson", 
            function(data){
                data.features.forEach(element => {
                    //console.log(element)
                    element.properties.STARTTIMEDATE = new Date(element.properties.STARTTIME);
                    element.properties.STOPTIMEDATE = new Date(element.properties.STOPTIME);
                });
                // console.log(data);
                var features = data.features;
                pathLayer.selectAll('path')
                    .data(features)
                    .enter()
                        .append('path').attr('d', path).attr('vector-effect', 'non-scaling-stroke')
                        .style('stroke','yellow')
                        .style("opacity", "0")
                    .filter(filterWork)
                    .style('stroke','red').style("opacity", "0.05");
        });

        var borgerhout = [[4.4517446478223,51.194863103201],[4.4512949709766,51.194884903266],[4.4508312578648,51.194816691798],[4.450285841695,51.194671432182],[4.4494611772294,51.194616391383],[4.4487937839023,51.194766705217],[4.4486250454785,51.194836768749],[4.4483974543249,51.194906737236],[4.4482937918364,51.195002957456],[4.4482537875402,51.19504075421],[4.4480298505592,51.195115303628],[4.447980766767,51.195172566494],[4.4478996744851,51.195234003646],[4.4479154122915,51.195301945927],[4.4479592531375,51.195374021884],[4.447946597153,51.195426684958],[4.447897646108,51.195561769951],[4.4478303188446,51.195608744271],[4.4476372738057,51.195638635281],[4.4475263441284,51.1957451515],[4.4473169352603,51.195793362519],[4.4472423356816,51.196082320199],[4.4470521225217,51.196484960493],[4.4470407967347,51.1969185182],[4.4470877305781,51.197448249506],[4.4471357443492,51.197551018553],[4.4472253096614,51.198163298225],[4.4467346033008,51.198137927881],[4.4466612169615,51.198157877187],[4.4466123606507,51.198191706321],[4.446539542099,51.198226090657],[4.4463316261027,51.198250425508],[4.4461760291084,51.1983009358],[4.4460670865339,51.198386676867],[4.4460605487352,51.198489482308],[4.4460946840732,51.198583703873],[4.4461357221948,51.198656420448],[4.4461292202502,51.19878058246],[4.4459822134544,51.200566157211],[4.4442042132602,51.200492316386],[4.4438722814695,51.200513311102],[4.443760478507,51.200631922603],[4.4437879004975,51.20072599625],[4.4439107033793,51.200773106922],[4.4440061404152,51.200901418832],[4.4440950973754,51.201021294664],[4.4441429072733,51.201141205909],[4.4441363646282,51.201243876308],[4.4441022888111,51.201325360645],[4.4440548066945,51.201406700788],[4.4440413182549,51.201496594049],[4.4440823764709,51.201590811634],[4.4441438709834,51.201732061636],[4.4442249651074,51.201837057509],[4.4443854805111,51.201977119962],[4.4444286266307,51.2021137436],[4.444398680101,51.20225308402],[4.4443152786918,51.20238276937],[4.444425369401,51.20299067736],[4.4441409179358,51.204035633492],[4.4444004324762,51.204416630339],[4.4443301786326,51.20548390993],[4.4443300808686,51.205485375109],[4.4443212439147,51.20562015355],[4.4440540167701,51.206437042555],[4.4440536181291,51.206438274228],[4.4440484072972,51.206436794485],[4.4434441672789,51.206264899931],[4.4434423062802,51.2062643708],[4.4434388445866,51.206265011187],[4.4429358395101,51.206358091615],[4.4427315686448,51.206546978106],[4.4426018805849,51.206820362485],[4.4425381160016,51.207212244704],[4.4422650072605,51.207415636073],[4.4416771621434,51.207526534465],[4.4424307789973,51.20817856926],[4.4387309931421,51.20853138809],[4.4371672274034,51.208678931991],[4.4358580863005,51.208803703517],[4.4318405474989,51.209203255166],[4.4282696459273,51.209921397895],[4.4271386885819,51.210179774606],[4.4272171995878,51.210297618554],[4.4273413341102,51.210473819399],[4.4276192944548,51.210945437154],[4.4274819346579,51.211038500514],[4.4275420241141,51.211162456606],[4.4276302628065,51.211253186258],[4.4276832243392,51.211319584002],[4.4277327223287,51.211430260437],[4.4276781496046,51.211670863085],[4.427654865431,51.211994790549],[4.4276417355619,51.212325274397],[4.427505154606,51.212886553022],[4.4276089823877,51.213157681299],[4.4276692265169,51.2132434993],[4.4277405787265,51.21346550413],[4.4277848600643,51.213557316403],[4.4277380662724,51.21386182257],[4.427528386865,51.214271467297],[4.4274992945683,51.214318320544],[4.427370044801,51.214427118278],[4.4273720210125,51.21455187644],[4.4273655339474,51.21461622773],[4.4273271774005,51.21465960706],[4.4272246927989,51.214771707923],[4.4270443470641,51.214822160105],[4.4267768034196,51.215101563183],[4.4267495476946,51.215164531535],[4.4267880155958,51.215322456752],[4.4267007520188,51.21548846204],[4.4267026573985,51.215558283047],[4.4265060187935,51.215698015334],[4.4272957935155,51.216226410202],[4.4277317672275,51.216544371503],[4.4278652866101,51.216647320137],[4.4278667622071,51.216648460918],[4.4278709827741,51.216647317256],[4.4280904803195,51.216587630864],[4.4280944862657,51.216586541233],[4.4280961764761,51.216587627972],[4.4284319129615,51.216802693325],[4.4284369788919,51.21680228626],[4.4285838621183,51.216790409382],[4.4285895582998,51.216790406466],[4.4286688608724,51.216823173511],[4.4287838015916,51.216922688063],[4.4288641338116,51.217031379486],[4.4290210181097,51.217148049057],[4.429052056244,51.21718808537],[4.4291214820382,51.217317392639],[4.4292163450134,51.217395165188],[4.4293360274787,51.217419821323],[4.4294635174047,51.217428186298],[4.4295091735932,51.217450067311],[4.4296005094796,51.217511545411],[4.4296113148427,51.217565470192],[4.4296207085033,51.217612483627],[4.4296754038032,51.217672767303],[4.4301944709846,51.217986667198],[4.4301974646916,51.217988481282],[4.4302001673121,51.217986664204],[4.4304555191298,51.21780816391],[4.4304572492974,51.217806949563],[4.4304612154354,51.217808160904],[4.4306996849838,51.217880813875],[4.4308654847278,51.217842309493],[4.4310654849489,51.217905490405],[4.4311945613174,51.218058988357],[4.4314127451116,51.218136684218],[4.4315186067469,51.218225855282],[4.431540146248,51.218267352144],[4.4318488333659,51.21834784789],[4.4330985703542,51.218582402382],[4.4337380632647,51.21896342656],[4.4343980718211,51.219200046134],[4.4346963279175,51.219264846536],[4.4350340459949,51.219270381322],[4.4352988042887,51.219310355249],[4.4355301434601,51.219390471854],[4.4360447546099,51.219680601091],[4.4367933936777,51.219798635285],[4.4373656282433,51.219935410199],[4.4375242760336,51.219610503502],[4.4375249181715,51.219609199807],[4.4375299725589,51.219610500155],[4.4380399374398,51.219741753559],[4.4382650012151,51.220240898421],[4.4385331059135,51.220510246871],[4.4387912111714,51.220969902868],[4.438888728218,51.221102135613],[4.4387894985063,51.221246791231],[4.4388752091801,51.221380100653],[4.4392441487566,51.221584077316],[4.4396112788573,51.222248430071],[4.4398860815173,51.222355989258],[4.4405627633049,51.223304129381],[4.440855362225,51.223601312231],[4.441330483287,51.224097581834],[4.4417951401926,51.224876890968],[4.4417961879226,51.224878643049],[4.4423172241295,51.225751951097],[4.4432898000619,51.226205249177],[4.4428035529754,51.226492205677],[4.4430544773545,51.226748215368],[4.4428343503354,51.226870677491],[4.4426013258478,51.22703893408],[4.4426776522588,51.227350674468],[4.4428499493279,51.227305129423],[4.4434421759219,51.227148589471],[4.4437544569337,51.227066038555],[4.4452575228038,51.226668706731],[4.4461696417436,51.22679212031],[4.4468133193175,51.226495077147],[4.4465539500956,51.225485882253],[4.4482387117058,51.225415514447],[4.4494118987045,51.224291165948],[4.4501373645743,51.223348709212],[4.4509480808057,51.222824013034],[4.4520540864249,51.222594028718],[4.452154933785,51.222089762467],[4.4522755090611,51.221493773439],[4.4530452956378,51.220618679127],[4.4537489037638,51.219535914608],[4.4542181700966,51.219336983929],[4.4544898887234,51.219223450903],[4.4556390678692,51.218449602883],[4.4558732207257,51.218099861275],[4.4557556942646,51.218035205044],[4.4560202225994,51.217902007142],[4.4564194952782,51.217834296394],[4.4568143184655,51.21777557604],[4.456700561993,51.217458262856],[4.4564778534917,51.217000020942],[4.4565443444918,51.216568527662],[4.4563607249397,51.216320638811],[4.4562114149751,51.216119355943],[4.4559058963543,51.215737288299],[4.4564700610515,51.215607524521],[4.4567448822961,51.215717426719],[4.4578566211655,51.21473952011],[4.4581806931862,51.214208750274],[4.457511585309,51.213805687519],[4.4573084553087,51.213088816899],[4.4566696890047,51.212230390819],[4.4564906357332,51.21204995646],[4.4559215684008,51.211833355287],[4.4557828157144,51.211667037652],[4.4556778315806,51.211513296592],[4.4556308799765,51.211399430054],[4.4553111328736,51.211363263362],[4.454151493531,51.211045905321],[4.4531150683864,51.210761120221],[4.4530972107483,51.210455841106],[4.453622960068,51.210259118483],[4.4536094043717,51.210155464735],[4.4534759217926,51.209976313989],[4.4534660173256,51.209764239121],[4.4534656672099,51.209573046448],[4.4533218681079,51.208954782027],[4.4531786309576,51.208650186316],[4.4529925942008,51.208336659686],[4.4529209302175,51.208154488585],[4.4528824415761,51.207912547483],[4.4529153662679,51.207715362467],[4.4529626854338,51.207580906391],[4.4529851964858,51.207519508171],[4.4530043308125,51.206947577967],[4.4530277314018,51.206738445061],[4.4530607145382,51.206574121617],[4.4530603062537,51.206350084978],[4.4529671464995,51.206077721201],[4.4528369467872,51.205665892216],[4.4525986056094,51.204669747498],[4.4527477523859,51.204447419298],[4.4529756055774,51.2042321712],[4.4530325141226,51.20414848378],[4.4532227019753,51.203993907333],[4.4534358070094,51.203782938447],[4.4536051969491,51.203617518331],[4.4539840301693,51.203322727877],[4.4534481664393,51.202960773661],[4.4531107754656,51.202082395323],[4.4547684666186,51.201132342022],[4.4554777534232,51.201471556377],[4.4557351908721,51.201421299958],[4.456260561778,51.20131873722],[4.4570991064592,51.201083707359],[4.4576021064683,51.200860853909],[4.457693891134,51.200111092501],[4.4573024240487,51.200087937846],[4.4572945343081,51.199867573588],[4.4571990772792,51.199679445114],[4.4571081969802,51.199392736577],[4.4570576804102,51.198822995597],[4.4570545981442,51.198714668879],[4.457087179448,51.198350188817],[4.4572236140702,51.197920796531],[4.4572834229574,51.197633677528],[4.45704431508,51.197321364511],[4.4567514348461,51.197415685021],[4.4548388638778,51.195113528726],[4.4548112889778,51.194955126969],[4.4547293401477,51.194873868296],[4.4542035192105,51.194214866571],[4.4536177682097,51.194386495794],[4.4522145044588,51.194751537053],[4.4522141040902,51.194751636212],[4.4517446478223,51.194863103201]]

        borgerhoutLayer.selectAll("circle")
            .data([borgerhout])
            .enter()
                .append("polygon")
                .attr("points", (d) => {
                    coordinates = d;
                    console.log(d)
                    points =d;
                    return points.map((p) => {
                        return projection(p).join(",");
                    }).join(" ");
                })
                .attr("fill", "green")
                .attr("opacity", "0.5");
                

        
        function update() {
            pathLayer.selectAll('path')
            .style("opacity", 0.00)
            .filter(filterWork)
            .style('stroke', 'red').style('opacity', 0.05);
        }

        function mouseover(){
            pathLayer.selectAll('path')
                    .style("opacity", "0.05")
                    .filter(filterWork)
                    .style('stroke','red').style("opacity", "0.00");
        }

        function mouseout() {
            pathLayer.selectAll('path').style("opacity", "0.00")
                    .filter(filterWork)
                    .style('stroke','red').style("opacity", "0.05");
        }

        function clicked(){
            console.log("clicked");
            pathLayer.selectAll('path')
                .style('stroke', 'green');
        }
    </script>
    <div id="time-slider"></div>
    <script src="rangeSlider.js"></script>
</body>
</html>